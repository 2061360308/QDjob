name: Build ARM64 Executable

on:
  push:
    tags:
      - 'v*.*.*'  # 当推送以 v 开头的标签时触发（例如 v1.0.0）
  workflow_dispatch:  # 也允许手动触发

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    name: Build ARM64 Executable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Prepare build environment
      run: |
        mkdir -p dist
        cp build.spec ./
        mkdir -p temp/src
        cp -r src/* temp/src/
    
    - name: Build executable in ARM64 container
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}/dist:/output \
          -v ${{ github.workspace }}/temp:/app/temp \
          python:3.11-bullseye-slim sh -c "
          
          # 安装构建依赖
          apt-get update && \
          apt-get install -y --no-install-recommends gcc g++ make && \
          rm -rf /var/lib/apt/lists/*
          
          # 设置 pip 镜像源
          pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
          
          # 安装 Python 依赖
          pip install --no-cache-dir -r /app/temp/src/requirements.txt
          pip install --no-cache-dir pyinstaller pillow cython
          
          # 开始编译 Cython 模块
          echo '开始编译 Cython 模块...' && \
          mkdir -p /app/src && \
          cp -r /app/temp/src/* /app/src/ && \
          cd /app/src && \
          cythonize -3 -j 6 -i QDjob.py && \
          cythonize -3 -j 6 -i enctrypt_qidian.py && \
          
          # 复制编译后的文件到应用目录
          cp *.so /app/ && \
          cp push.py /app/ && \
          cp main.py /app/ && \
          cp Captcha.py /app/ && \
          cp logger.py /app/ && \
          
          # 创建必要的目录
          mkdir -p /app/dist && \
          
          # 执行 PyInstaller 打包
          cd /app && \
          pyinstaller --distpath /app/dist --workpath /app/build --clean --noconfirm /app/temp/build.spec && \
          
          # 复制结果到输出目录
          cp /app/dist/QDjob /output/ && \
          
          # 清理临时资源
          echo '清理临时资源...' && \
          rm -rf /app/src/*
        "
    
    - name: Verify ARM64 binary
      run: |
        if ! file dist/QDjob | grep -q "ARM aarch64"; then
          echo "Error: Binary is not ARM64 architecture"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: QDjob-arm64
        path: dist/QDjob
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/QDjob
        name: Release ${{ github.ref_name }}
        body: "ARM64 架构的 QDjob 可执行文件"
