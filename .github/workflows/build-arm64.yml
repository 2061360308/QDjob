name: Build ARM64 Executable

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    name: Build ARM64 Executable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Prepare build environment
      run: |
        mkdir -p dist
        cp build.spec ./
        mkdir -p temp/src
        cp -r src/* temp/src/
    
    - name: Build executable in ARM64 container
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}/dist:/output \
          -v ${{ github.workspace }}/temp:/app/temp \
          python:3.11-bullseye-slim sh -c "
          
          # 安装构建依赖
          apt-get update && \
          apt-get install -y --no-install-recommends gcc g++ make && \
          rm -rf /var/lib/apt/lists/*
          
          # 设置 pip 镜像源
          pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
          
          # 安装 Python 依赖
          pip install --no-cache-dir -r /app/temp/src/requirements.txt
          pip install --no-cache-dir pyinstaller pillow cython
          
          # 编译 Cython 模块
          echo '开始编译 Cython 模块...' && \
          mkdir -p /app/src && \
          cp -r /app/temp/src/* /app/src/ && \
          cd /app/src && \
          cythonize -3 -j 6 -i QDjob.py && \
          cythonize -3 -j 6 -i enctrypt_qidian.py && \
          
          # 复制编译后的文件
          cp *.so /app/ && \
          cp push.py /app/ && \
          cp main.py /app/ && \
          cp Captcha.py /app/ && \
          cp logger.py /app/ && \
          
          # 执行 PyInstaller 打包
          mkdir -p /app/dist && \
          cd /app && \
          pyinstaller --distpath /app/dist --workpath /app/build --clean --noconfirm /app/temp/build.spec && \
          
          # 复制结果到输出目录
          cp /app/dist/QDjob /output/ && \
          
          # 清理临时资源（关键：确保不留下源码）
          echo '清理临时资源...' && \
          rm -rf /app/src/* /app/temp
        "
    
    - name: Verify ARM64 binary
      run: |
        if ! file dist/QDjob | grep -q "ARM aarch64"; then
          echo "错误: 生成的二进制文件不是ARM64架构"
          exit 1
        fi
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v3
      with:
        name: QDjob-arm64
        path: dist/QDjob
